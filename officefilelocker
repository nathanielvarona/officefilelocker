#!/usr/bin/env jython
import os, sys, ConfigParser

try:
    config = ConfigParser.ConfigParser()
    config.read("apache.cfg")
    APACHE_POI_JAR_PATH = config.get("POI", "path")
except Exception:
    APACHE_POI_JAR_PATH = os.environ["APACHE_POI_JAR_PATH"]

for root, dirs, files in os.walk(APACHE_POI_PATH):
    for name in files:
        if name.endswith(".jar"):
            sys.path.append(os.path.join(root, name))

from org.apache.poi.xssf.usermodel import *
from java.io import FileInputStream
from java.io import FileOutputStream


sheet_password = sys.argv[1]
input_file = sys.argv[2]
output_file = sys.argv[3]

fileIn = FileInputStream(input_file)
fileOut = FileOutputStream(output_file)

workbook = XSSFWorkbook(fileIn)
worksheets = workbook.getNumberOfSheets()

for worksheet in range(0,worksheets):
    sheet = workbook.getSheetAt(worksheet)
    # print "Locking: %s" % sheet.sheetName.title()
    sheet.lockDeleteColumns()
    sheet.lockDeleteRows()
    sheet.lockFormatCells()
    sheet.lockFormatColumns()
    sheet.lockFormatRows()
    sheet.lockInsertColumns()
    sheet.lockInsertRows()
    sheet.protectSheet(sheet_password)
    sheet.enableLocking();

workbook.lockStructure();
workbook.write(fileOut)
fileIn.close()
